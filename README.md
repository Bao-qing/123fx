# 123分享社区增强（123fx）

一个 Tampermonkey 油猴脚本，用于增强 123 分享社区/相关站点的使用体验：**一键回复**、**分享链接有效性检测**、**一键转存到自己的 123 网盘**，并在 123 网盘站点提供一个**浮动按钮**用于采集必要的登录信息。

请阅读使用说明，了解如何安装与使用该脚本。


## 功能一览

- **快捷回复**：在帖子页检测到回复提示区域时，插入“回复”按钮；点击后自动提交默认回复并刷新页面。
- **链接检测**：在帖子内容的链接提示区域内，扫描 `123` 分享链接并调用检测接口校验有效性；有效/失效会改变链接样式并 toast 提示。
- **一键保存到网盘**：对有效的分享链接追加“保存到网盘”按钮；点击后会把该分享链接下的文件列表获取出来并调用 123 网盘的“转存”接口保存到你的网盘根目录（或你当前目录）。
- **登录信息采集（浮动按钮）**：在 123网盘站点显示一个浮动按钮；点击从浏览器存储中读取登录记录和**当前目录** 并保存到 Tampermonkey 存储
一键保存会保存到这个目录。

## 安装

1. 浏览器安装 Tampermonkey（油猴）。
2. 在 Greasy Fork [123分享增强](https://greasyfork.org/zh-CN/scripts/465283-123fx) 安装脚本。
3. 或手动导入 `123fx.user.js`。


## 使用方法

### 1）先在 123 网盘站点“记录”登录信息

1. 打开任意 123 网盘页面（例如 `https://www.123pan.com/` / `https://www.123865.com/`）。
2. 确保你已登录。
3. 页面右侧会出现浮动按钮。点击它：
   - 成功：按钮短暂显示 `OK` 并写入 Tampermonkey 存储。
   - 失败：按钮短暂显示 `Err`，说明未取到必要信息。

脚本保存的内容（Tampermonkey `GM_setValue`）：

- `authorization`：来自 `localStorage['authorToken']`
- `loginUuid`：来自 `localStorage['LoginUuid']`
- `parentFileId`：来自 `sessionStorage['filePath']` 中的 `homeFilePath` 末级（取不到则为 `0`）

> 以上 key 都可以在 `123fx.user.js` 的 `panWebManager` 配置里调整（见“配置项”）。

### 2）在分享社区帖子里自动检测链接 + 一键转存

1. 打开帖子页面。
2. 如果页面存在回复提示会插入“回复”按钮：
   - 点击“回复”会用默认文案发帖并自动刷新。
3. 如果帖子内容存在链接提示区，脚本会：
   - 扫描其中的分享链接（`/s/<shareKey>` 形式）
   - 检测有效性：
     - 有效：链接变绿并提示“链接有效”，同时在链接后追加“保存到网盘”按钮
     - 失效：链接变红并标注原因
4. 点击“保存到网盘”后：
   - 脚本会自动尝试寻找提取码：优先从 URL 的 `?pwd=` 读取；没有则从帖子内容里解析（`提取码/密码/访问码` 等）。
   - 添加一键保存按钮，分页拉取分享文件列表并调用转存接口保存到你的网盘目录。

## 配置项

 `DEFAULT_OPTIONS` 可以调整默认行为（如需更复杂定制，可修改构造参数）。

- `defaultReplyContent`：默认回复内容
- `getShareInfoRetry`：获取分享列表的重试次数
- `checkLinkHost`：链接检测 API Host（默认 `www.123pan.com`）
- `shareApiHost`：分享/转存 API Host（默认 `www.123865.com`）
- `panHosts`：在哪些网盘域名启用“记录”浮动按钮
- `floatButtonText`：浮动按钮文字（默认“记录”）


## 常见问题（FAQ）

- **点击“保存到网盘”提示“未初始化信息，请先前往设置”**
  - 说明 Tampermonkey 存储里没有 `authorization/loginUuid/parentFileId`。
  - 解决：先去 123 网盘**欲保存的目录**页面点一次浮动“记录”按钮。

- **保存失败，提示 401/未授权**
  - 你的 `Authorization` 或 `LoginUuid` 可能已过期（重新登录后再点“记录”更新）。

- **提取码识别不准**
  - 脚本会优先读 URL 的 `?pwd=`，其次在帖子内容中按相邻位置匹配“提取码”。如果帖子排版很特殊，可能匹配不到。



## 安全与隐私

- 脚本会把 `Authorization`、`LoginUuid`、`parentFileId` 写入 Tampermonkey 的本地存储（`GM_setValue`），用于调用 123 网盘接口完成转存。

